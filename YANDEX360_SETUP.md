# Настройка Яндекс 360 для отправки писем

## Что такое Яндекс 360?

Яндекс 360 — это корпоративная почта от Яндекса для бизнеса. Предоставляет:
- Надежный SMTP сервер для отправки писем
- Порт 465 (SSL) обычно не блокируется провайдерами
- Российский сервис с хорошей поддержкой
- Возможность отправлять от имени вашего домена (uchiteltut.ru)

## Пошаговая настройка

### Шаг 1: Верификация домена

1. В панели Яндекс 360 вы получили инструкцию добавить TXT-запись в DNS
2. Откройте настройки DNS вашего домена (где вы управляете DNS записями)
3. Добавьте TXT-запись:
   - **Хост/Имя**: `@` (или оставьте пустым)
   - **Тип**: `TXT`
   - **Значение**: `yandex-verification: c27c6d631b980759`
4. Сохраните изменения
5. Подождите обновления DNS (обычно 5-30 минут, максимум 72 часа)
6. Нажмите "Проверить" в панели Яндекс 360

### Шаг 2: Создание почтового ящика

1. В панели Яндекс 360 создайте почтовый ящик для отправки писем:
   - Например: `noreply@uchiteltut.ru` или `no-reply@uchiteltut.ru`
   - Или используйте существующий ящик

### Шаг 3: Создание пароля приложения

⚠️ **ВАЖНО**: Для SMTP нужен **пароль приложения**, а не основной пароль!

#### Способ 1: Через Яндекс ID (рекомендуется)

1. Откройте https://id.yandex.ru/security
2. Войдите в аккаунт, где создан ящик `no-reply@uchiteltut.ru`
3. Найдите раздел **"Пароли приложений"**
   - Если не видите, возможно нужно включить двухфакторную аутентификацию (2FA)
4. Нажмите **"Создать новый пароль"** или **"Создать пароль приложения"**
5. Выберите тип:
   - **"Почта"** или **"Другое"**
   - Если "Другое", введите: `SMTP для uchiteltut.ru`
6. Нажмите **"Создать"**
7. **Скопируйте пароль** (он показывается только один раз!)
   - Пароль выглядит как строка букв и цифр: `abcdefghijklmnop`

#### Способ 2: Прямая ссылка

Если не видите раздел "Пароли приложений", попробуйте прямую ссылку:
- https://id.yandex.ru/security/app-passwords

#### Если не видите "Пароли приложений"

1. Включите **двухфакторную аутентификацию (2FA)** в настройках безопасности
2. После включения 2FA появится раздел "Пароли приложений"

#### Важно помнить

- ✅ Пароль приложения показывается **только один раз**
- ✅ Сохраните его в безопасном месте
- ✅ Это НЕ ваш основной пароль от почты
- ✅ Можно создать несколько паролей приложений для разных сервисов

### Шаг 4: Настройка на сервере

После завершения верификации домена и создания пароля приложения, пришлите мне:

1. **Email ящика** (например: `noreply@uchiteltut.ru`)
2. **Пароль приложения** (который вы создали в шаге 3)

Я настрою на сервере автоматически.

Или настройте вручную:

```bash
ssh root@91.229.9.105
cd /opt/uchiteltut
nano .env
```

Добавьте/обновите:

```env
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=no-reply@uchiteltut.ru
SMTP_PASS=ваш_пароль_приложения_из_яндекс360
MAIL_FROM="УчительТут <no-reply@uchiteltut.ru>"
```

Сохраните и перезапустите:

```bash
docker-compose -f docker-compose.prod.yml restart server
```

## Преимущества Яндекс 360

✅ Надежный российский сервис  
✅ Порт 465 обычно не блокируется  
✅ Отправка от имени вашего домена  
✅ Хорошая доставляемость писем  
✅ Бесплатный тариф для небольших объемов

## Проверка

После настройки попробуйте отправить отклик на вакансию через форму на сайте. Письма должны прийти на:
- Email из вакансии (указанный в поле `email` вакансии)
- 79644228177@mail.ru (копия, автоматически добавляется)

### Как работает отправка писем

1. Когда пользователь нажимает "Откликнуться на вакансию" на странице вакансии
2. Заполняет форму (ФИО, телефон, образование, опыт работы, резюме)
3. При отправке формы данные отправляются на `/api/respond`
4. Сервер:
   - Проверяет наличие SMTP настроек
   - Подключается к SMTP серверу Яндекс 360
   - Формирует письмо с данными кандидата
   - Отправляет письмо на email из вакансии И на 79644228177@mail.ru
   - Прикрепляет резюме, если оно было загружено

### Формат письма

Письма отправляются в двух форматах:
- **HTML** - красиво оформленное письмо с информацией о вакансии и кандидате
- **Текст** - простая текстовая версия для почтовых клиентов без поддержки HTML

### Обработка ошибок

Если что-то пошло не так:
- Проверьте логи сервера для детальной информации об ошибке
- Убедитесь, что SMTP настройки правильные
- Проверьте, что пароль приложения создан правильно
- Убедитесь, что домен верифицирован в Яндекс 360

### Локальная разработка

Для локальной разработки создайте файл `.env` в папке `newServer` на основе `env.example`:

```bash
cd newServer
cp ../env.example .env
# Отредактируйте .env и добавьте ваши SMTP настройки
```

Затем запустите сервер:

```bash
npm start
# или для разработки с автоперезагрузкой:
npm run dev
```

